<html lang="en" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wishlist üîç(‡πë‚Ä¢ . ‚Ä¢‡πë)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Apply dark mode based on system preference
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
</head>

<body class="h-full bg-[#e6ecf0] dark:bg-[#181a1b] py-6 text-gray-900 dark:text-gray-100 transition-all duration-200">
    <div class="w-full max-w-2xl mx-auto p-6 bg-white dark:bg-[#292c2e] rounded-lg shadow-lg">
        <noscript>
            <p class="text-red-500 dark:text-red-400 mb-4">JavaScript is disabled. Please enable JavaScript to use this
                page.
            </p>
        </noscript>
        <!-- Title and Input -->
        <div class="py-6">
            <a href="/" class="text-5xl font-bold text-center block text-teal-500">Skeb info</a>
            <div class="text-2xl font-bold text-center block text-teal-500 opacity-50 mb-4">Wishlist</div>
            <div class="text-4xl mb-4 text-center">
                <span id="spyglass" class="inline-block cursor-default select-none">üîç</span><span id="tinyko"
                    class="inline-block cursor-pointer select-none">(‡πë‚Ä¢ . ‚Ä¢‡πë)</span>
            </div>
        </div>
        <div class="py-2 px-4">
            <div class="mb-4 relative">
                <input id="username" type="text" placeholder="Skeb creator username" oninput="restore()"
                    class="w-full p-2 border rounded bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-cyan-500 dark:focus:ring-cyan-400 pr-10" />
                <button id="clearInput" type="button"
                    class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200"
                    onclick="clearInput()">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <button id="addCreator" onclick="addCreator()"
                class="w-full bg-[#28837f] text-white p-2 rounded hover:bg-[#206966] dark:hover:bg-[#206966] transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Add
                Creator</button>
            <button id="updateAll" onclick="updateAllCreators()"
                class="w-full mt-2 bg-gray-500 text-white p-2 rounded hover:bg-gray-600 dark:hover:bg-gray-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Update
                All Creators
            </button>
        </div>

        <div id="error-message" class="mt-8"></div>
        <!-- Creator List -->
        <div id="creator-list" class="mt-8"></div>
    </div>
    <script>
        const hostURL = "/";
        const tinyko = document.getElementById("tinyko");
        const spyglass = document.getElementById("spyglass");
        const usernameInput = document.getElementById('username');
        const addCreatorButton = document.getElementById('addCreator');
        const updateAllButton = document.getElementById('updateAll');
        const errorMessageDiv = document.getElementById('error-message');
        const creatorListDiv = document.getElementById('creator-list');
        const searchButtonDefaultClasses = addCreatorButton.className;

        // tinyko (‡πë‚Ä¢ . ‚Ä¢‡πë)
        let tnkBeforeState = tinyko.innerHTML;
        tinyko.addEventListener("click", () => {
            if (tinyko.classList.contains("animate__rubberBand")) {
                return;
            }
            tnkBeforeState = tinyko.innerHTML;
            tinyko.classList.add("animate__animated", "animate__rubberBand");
            setTimeout(() => {
                tinyko.innerHTML = "(‡πë>.<‡πë)";
            }, 100);
        });
        tinyko.addEventListener('animationend', () => {
            tinyko.classList.remove("animate__animated", "animate__rubberBand");
            tinyko.innerHTML = tnkBeforeState;
        });

        // Input enter
        usernameInput.addEventListener('keypress', function (event) {
            if (event.key === 'Enter') {
                !addCreatorButton.disabled && addCreator();
                usernameInput.blur();
            }
        });

        function clearInput() {
            usernameInput.value = '';
            usernameInput.focus();
            restore();
        }

        function restore() {
            errorMessageDiv.innerHTML = '';
            addCreatorButton.className = searchButtonDefaultClasses;
            addCreatorButton.textContent = "Add Creator";
            addCreatorButton.disabled = false;
            updateAllButton.disabled = false;
            tinyko.innerHTML = "(‡πë‚Ä¢ . ‚Ä¢‡πë)";
            spyglass.innerHTML = "üîç";
            spyglass.classList.remove("animate__animated", "animate__infinite", "animate__bounceIn", "animate__pulse");
        }

        function disableButtons() {
            addCreatorButton.disabled = true;
            updateAllButton.disabled = true;
            addCreatorButton.classList.remove('hover:bg-[#206966]', 'dark:hover:bg-[#206966]');
        }

        // Load creators from localStorage
        function loadCreators() {
            const creators = JSON.parse(localStorage.getItem('skebWishlist') || '[]');
            renderCreatorList(creators);
        }

        // Save creators to localStorage
        function saveCreators(creators) {
            localStorage.setItem('skebWishlist', JSON.stringify(creators));
            renderCreatorList(creators);
        }

        // Render creator list
        function renderCreatorList(creators) {
            if (!creators.length) {
                creatorListDiv.innerHTML = '<p class="text-gray-500 dark:text-gray-400 py-2 px-4">No creators in wishlist.</p>';
                return;
            }

            const tableHtml = `
                <div class="mt-8">
                    <h2 class="text-l font-bold mb-4 py-2 px-4">Wishlist Creators</h2>
                    <hr/>
                    <div class="max-h-64 overflow-y-auto">
                        <table class="w-full text-left border-collapse">
                            <tbody>
                                ${creators.map((creator, index) => {
                const avgResponseDays = creator.received_requests_average_response_time ? (creator.received_requests_average_response_time / 86400).toFixed(0) : '';
                const avgCompletionDays = creator.completing_average_time ? (creator.completing_average_time / 86400).toFixed(0) : '';
                const acceptExpiration = creator.accept_expiration_days || '';
                const completeExpiration = creator.complete_expiration_days || '';
                const timeInfo = (avgResponseDays || acceptExpiration) ?
                    `${acceptExpiration ? `${acceptExpiration}/${completeExpiration}` : ''} ${avgResponseDays ? `(${avgResponseDays}/${avgCompletionDays})` : ''}` : '';
                const skillsHtml = creator.skills?.length > 1 ?
                    creator.skills.map(skill => `<span class="font-bold">${skill.genre}</span> ${skill.default_amount}`).join('<br>') :
                    `${creator.skills[0].default_amount}`;
                const acceptingStatus = creator.acceptable ?
                    '<span class="inline-block w-2 h-2 rounded-full bg-green-500"></span>' :
                    '<span class="inline-block w-2 h-2 rounded-full bg-gray-500"></span>';
                return `
                    <tr class="border-t border-gray-300 dark:border-gray-600">
                        <td class="py-2 px-4 text-sm sm:text-base">
                            ${acceptingStatus}
                            <a href="https://skeb.jp/@${creator.screen_name}" target="_blank" class="text-[#28837f] hover:underline ml-1">${creator.name}</a>
                        </td>
                        <td class="py-2 px-4 text-sm sm:text-base">${skillsHtml}</td>
                        <td class="py-2 px-4 text-sm sm:text-base">${timeInfo}</td>
                        <td class="py-2 px-4 text-sm sm:text-base flex space-x-2">
                            <button onclick="moveCreator(${index}, -1)" ${index === 0 ? 'disabled' : ''} class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                                </svg>
                            </button>
                            <button onclick="moveCreator(${index}, 1)" ${index === creators.length - 1 ? 'disabled' : ''} class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <button onclick="deleteCreator(${index})" class="text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-600">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            creatorListDiv.innerHTML = tableHtml;
        }

        // Add creator to wishlist
        async function addCreator() {
            try {
                const usernameInputValue = usernameInput.value.trim();
                let username = usernameInputValue;
                if (username.startsWith('https://skeb.jp/')) {
                    username = username.split('/works/')[0].replace('https://skeb.jp/@', '');
                } else if (username.startsWith('@')) {
                    username = username.slice(1);
                }
                username = username.replace(/\s+/g, '_').split('?')[0];
                if (!username) {
                    throw new Error('Username required');
                }
                const isValidUsername = /^[a-zA-Z0-9_]+$/.test(username);
                if (!isValidUsername) {
                    throw new Error('Incorrect username format');
                }
                usernameInput.value = username;
                disableButtons();
                spyglass.classList.add("animate__animated", "animate__infinite", "animate__pulse");
                addCreatorButton.textContent = 'Loading...';
                const response = await fetch(`${hostURL}api/users/${username}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Unknown error');
                }
                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                }
                if (!data.creator) {
                    throw new Error('User is not a creator');
                }
                const creators = JSON.parse(localStorage.getItem('skebWishlist') || '[]');
                if (creators.some(c => c.screen_name === data.screen_name)) {
                    throw new Error('Creator already in wishlist');
                }
                creators.unshift(data);
                saveCreators(creators);
                restore();
                usernameInput.value = '';
            } catch (error) {
                addCreatorButton.textContent = error.message.includes('not found') ? 'User not found' : 'Error';
                addCreatorButton.classList.remove('bg-[#28837f]', 'hover:bg-[#206966]', 'dark:hover:bg-[#206966]');
                addCreatorButton.classList.add(error.message.includes('not found') ? 'bg-gray-600' : 'bg-red-500', 'opacity-50');
                spyglass.innerHTML = error.message.includes('not found') ? '‚ùî' : '‚ùå';
                spyglass.classList.remove("animate__animated", "animate__infinite", "animate__pulse");
                spyglass.classList.add("animate__animated", "animate__bounceIn");
                if (error.message.includes('not found')) tinyko.innerHTML = "(‡πë>.<‡πë)";
                else errorMessageDiv.innerHTML = `<p class="text-red-500 dark:text-red-400 py-2 px-4">Error: ${error.message}</p>`;
                setTimeout(restore, 2500);
            }
        }

        // Update all creators
        async function updateAllCreators() {
            try {
                disableButtons();
                updateAllButton.textContent = 'Updating...';
                spyglass.classList.add("animate__animated", "animate__infinite", "animate__pulse");
                const creators = JSON.parse(localStorage.getItem('skebWishlist') || '[]');
                const updatedCreators = [];
                for (const creator of creators) {
                    try {
                        const response = await fetch(`${hostURL}api/users/${creator.screen_name}`);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.creator) {
                                updatedCreators.push(data);
                            } else {
                                updatedCreators.push(creator); // Keep old data if no longer a creator
                            }
                        } else {
                            updatedCreators.push(creator); // Keep old data on error
                        }
                    } catch {
                        updatedCreators.push(creator); // Keep old data on error
                    }
                }
                saveCreators(updatedCreators);
                restore();
                updateAllButton.textContent = 'Update All Creators';
            } catch (error) {
                updateAllButton.textContent = 'Error';
                updateAllButton.classList.remove('bg-gray-500', 'hover:bg-gray-600', 'dark:hover:bg-gray-600');
                updateAllButton.classList.add('bg-red-500', 'opacity-50');
                spyglass.innerHTML = '‚ùå';
                spyglass.classList.remove("animate__animated", "animate__infinite", "animate__pulse");
                spyglass.classList.add("animate__animated", "animate__bounceIn");
                tinyko.innerHTML = "(‡πë>.<‡πë)";
                setTimeout(restore, 2500);
            }
        }

        // Move creator up or down
        function moveCreator(index, direction) {
            const creators = JSON.parse(localStorage.getItem('skebWishlist') || '[]');
            const newIndex = index + direction;
            if (newIndex >= 0 && newIndex < creators.length) {
                [creators[index], creators[newIndex]] = [creators[newIndex], creators[index]];
                saveCreators(creators);
            }
        }

        // Delete creator
        function deleteCreator(index) {
            const creators = JSON.parse(localStorage.getItem('skebWishlist') || '[]');
            creators.splice(index, 1);
            saveCreators(creators);
        }

        // Initial load
        loadCreators();
    </script>
</body>

</html>